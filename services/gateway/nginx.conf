upstream auth_service {
    server auth-service:8000;
}

upstream institution_service {
    server institution-service:8000;
}

upstream application_service {
    server application-service:3004;
}

upstream document_service {
    server document-service:3006;
}

upstream notification_service {
    server notification-service:3003;
}

upstream reporting_service {
    server reporting-analytics:3010;
}

server {
    listen 80;
    server_name _;

    client_max_body_size 20M;

    # ─── Common proxy settings ───────────────────────────────────
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_connect_timeout 10s;
    proxy_read_timeout    60s;

    # ─── Gateway health ──────────────────────────────────────────
    location = /health {
        default_type application/json;
        return 200 '{"status":"ok","service":"api-gateway"}';
    }

    # ─── Auth Service (Laravel :8000) ────────────────────────────
    location = /api/register {
        proxy_pass http://auth_service;
    }
    location = /api/login {
        proxy_pass http://auth_service;
    }
    location = /api/logout {
        proxy_pass http://auth_service;
    }
    location = /api/profile {
        proxy_pass http://auth_service;
    }
    location = /api/validate-token {
        proxy_pass http://auth_service;
    }
    location /api/users {
        proxy_pass http://auth_service;
    }
    location /api/configurations {
        proxy_pass http://auth_service;
    }
    location /api/reports {
        proxy_pass http://auth_service;
    }

    # ─── Institution Service (Laravel :8000) ─────────────────────
    location = /api/catalog {
        proxy_pass http://institution_service;
    }
    location /api/formations {
        proxy_pass http://institution_service;
    }
    location /api/establishments {
        proxy_pass http://institution_service;
    }
    location /api/programs {
        proxy_pass http://institution_service;
    }
    location /api/stats {
        proxy_pass http://institution_service;
    }

    # ─── Application Service (Go :3004) ──────────────────────────
    location /api/applications {
        proxy_pass http://application_service;
    }
    location = /api/my-applications {
        proxy_pass http://application_service;
    }
    location /api/establishment {
        proxy_pass http://application_service;
    }

    # ─── Notification Service (NestJS :3003) ─────────────────────
    location /api/notifications {
        proxy_pass http://notification_service;
    }

    # ─── Document Service (Go :3006) ─────────────────────────────
    location /api/documents {
        rewrite ^/api(.*)$ $1 break;
        proxy_pass http://document_service;
    }

    # ─── Reporting / Analytics Service (Node :3010) ──────────────
    location /api/analytics {
        rewrite ^/api/analytics(.*)$ /api/reports$1 break;
        proxy_pass http://reporting_service;
    }

    # ─── Per-service health checks ───────────────────────────────
    location = /health/auth {
        proxy_pass http://auth_service/api/health;
    }
    location = /health/institution {
        proxy_pass http://institution_service/api/health;
    }
    location = /health/application {
        proxy_pass http://application_service/health;
    }
    location = /health/document {
        proxy_pass http://document_service/health;
    }
    location = /health/notification {
        proxy_pass http://notification_service/health;
    }
    location = /health/reporting {
        proxy_pass http://reporting_service/health;
    }
}
